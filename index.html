<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√™t de mat√©riels IA ‚Äì R√©servations ‚Ä¢ build 2025-11-10-16h00</title>
  <style>
    :root{
      --bg:#0f1419;
      --bg-gradient:#0a0e13;
      --panel:#1a1f2e;
      --panel-hover:#232938;
      --muted:#8b92a9;
      --text:#e8eaed;
      --accent:#4f9cf9;
      --accent-hover:#6ba7ff;
      --ok:#4ade80;
      --warn:#fbbf24;
      --err:#f87171;
      --line:#2a3142;
      --chip:#162033;
      --chip-border:#2d4a7c;
      --input-bg:#0d1117;
      --slot-free:#162033;
      --slot-free-hover:#1e2d47;
      --slot-busy:#2d1b1b;
      --slot-busy-border:#4a2626;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0;
      background:linear-gradient(135deg,var(--bg),var(--bg-gradient));
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
    }
    
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(26,31,46,0.85);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:20px;
    }
    
    h1{
      font-size:26px;
      margin:4px 0;
      font-weight:700;
      background:linear-gradient(135deg,#fff,#8b92a9);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    
    .sub{
      color:var(--muted);
      font-size:14px;
      margin-top:4px;
    }
    
    .grid{
      display:grid;
      gap:20px;
    }
    
    .cols-2{
      grid-template-columns:2fr 1fr;
    }
    
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      transition:transform 0.2s,box-shadow 0.2s;
    }
    
    .panel:hover{
      box-shadow:0 12px 48px rgba(0,0,0,0.5);
    }
    
    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .row.wrap{
      flex-wrap:wrap;
    }
    
    .sp{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    input,select,button,textarea{
      background:var(--input-bg);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:12px 16px;
      font:inherit;
      transition:all 0.2s;
    }
    
    input:focus,select:focus,textarea:focus{
      outline:2px solid var(--accent);
      border-color:transparent;
      background:rgba(79,156,249,0.05);
    }
    
    button{
      cursor:pointer;
      font-weight:500;
    }
    
    .btn{
      background:var(--panel);
      border:1px solid var(--line);
      color:var(--text);
      transition:all 0.2s;
    }
    
    .btn:hover{
      background:var(--panel-hover);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-hover));
      border:0;
      color:#fff;
      font-weight:600;
      box-shadow:0 4px 16px rgba(79,156,249,0.3);
    }
    
    .btn-primary:hover{
      box-shadow:0 6px 20px rgba(79,156,249,0.4);
      transform:translateY(-2px);
    }
    
    .muted{color:var(--muted)}
    .title{font-weight:700;font-size:18px;margin-bottom:12px;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    .hidden{display:none}
    
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    
    .table th,.table td{
      padding:12px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    
    .table th{
      color:var(--accent);
      font-weight:600;
      background:rgba(79,156,249,0.1);
    }
    
    .foot{
      color:var(--muted);
      font-size:13px;
      margin-top:12px;
    }
    
    @media (max-width:980px){
      .cols-2{grid-template-columns:1fr}
    }

    /* Grille ressources am√©lior√©e */
    .res-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:14px;
      margin-bottom:20px;
    }
    
    .card-res{
      border:2px solid var(--line);
      border-radius:14px;
      padding:16px;
      background:linear-gradient(135deg,var(--input-bg),var(--panel));
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    
    .card-res::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:2px;
      background:linear-gradient(90deg,transparent,var(--accent),transparent);
      transform:translateX(-100%);
      transition:transform 0.5s;
    }
    
    .card-res:hover::before{
      transform:translateX(100%);
    }
    
    .card-res:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(79,156,249,0.2);
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(79,156,249,0.1),var(--panel));
    }
    
    .card-res.active{
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(79,156,249,0.2),var(--panel));
      box-shadow:0 0 0 4px rgba(79,156,249,0.2),0 10px 30px rgba(79,156,249,0.3);
    }
    
    .card-res .icon{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-hover));
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
      font-size:20px;
    }
    
    .card-res .name{
      font-weight:700;
      font-size:16px;
      margin-bottom:4px;
    }
    
    .card-res .meta{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    
    .chip{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chip-border);
      color:var(--accent);
      font-size:12px;
      margin-top:8px;
      font-weight:500;
    }

    /* Calendrier am√©lior√© */
    .calendar{
      display:grid;
      grid-template-columns:140px repeat(5,1fr);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:var(--input-bg);
    }
    
    .calendar .h{
      background:linear-gradient(135deg,rgba(79,156,249,0.1),rgba(79,156,249,0.05));
      padding:12px;
      font-weight:700;
      border-bottom:1px solid var(--line);
      color:var(--text);
    }
    
    .slot{
      padding:14px;
      border-left:1px solid var(--line);
      border-bottom:1px solid var(--line);
      min-height:70px;
      cursor:pointer;
      transition:all 0.2s;
      position:relative;
    }
    
    .slot.free{
      background:var(--slot-free);
    }
    
    .slot.free:hover{
      background:var(--slot-free-hover);
      box-shadow:inset 0 0 20px rgba(79,156,249,0.1);
    }
    
    .slot.busy{
      background:var(--slot-busy);
      border-left:2px solid var(--err);
      cursor:not-allowed;
    }
    
    .slot .who{
      font-size:13px;
      color:var(--text);
      font-weight:500;
    }
    
    .slot .libre-badge{
      display:inline-block;
      padding:4px 8px;
      background:rgba(74,222,128,0.1);
      color:var(--ok);
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }
    
    /* Animations */
    @keyframes slideIn{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .panel{
      animation:slideIn 0.5s ease-out;
    }
    
    /* Dialog am√©lior√© */
    dialog{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:16px;
      padding:0;
      width:min(560px,96vw);
      color:var(--text);
      box-shadow:0 20px 60px rgba(0,0,0,0.8);
    }
    
    dialog::backdrop{
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(4px);
    }

    /* Google Sheets Link */
    .sheets-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      background:linear-gradient(135deg,#34a853,#0f9d58);
      color:white;
      border-radius:8px;
      text-decoration:none;
      font-weight:500;
      transition:all 0.2s;
      font-size:14px;
    }
    
    .sheets-link:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(52,168,83,0.4);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap sp">
      <div>
        <h1>ü§ñ Pr√™t de mat√©riels IA</h1>
        <div class="sub">R√©servation de ressources IA ‚Ä¢ Cr√©neaux demi-journ√©e</div>
      </div>
      <div class="row">
        <select id="typeFilter">
          <option value="">Tous les types</option>
          <option value="Mat√©riel">Mat√©riel</option>
          <option value="Abonnement">Abonnement</option>
        </select>
        <input id="q" placeholder="üîç Rechercher..." />
        <a href="#" id="sheetsLink" target="_blank" class="sheets-link">
          üìä Google Sheets
        </a>
        <span id="syncStatus" style="color:var(--ok);font-size:12px;margin-left:8px;display:none">‚úì Synchronis√©</span>
      </div>
    </div>
  </header>

  <main class="wrap grid cols-2" style="margin-top:24px">
    <section class="panel" style="padding:20px">
      <div class="sp" style="margin-bottom:16px">
        <div>
          <div class="title">üìÖ Ressources disponibles</div>
          <div class="muted" style="font-size:13px">S√©lectionnez une ressource pour voir son planning</div>
        </div>
        <div class="row">
          <button class="btn" id="prevWeek">‚óÄ Semaine -1</button>
          <button class="btn" id="nextWeek">Semaine +1 ‚ñ∂</button>
        </div>
      </div>
      
      <div id="resourceGrid" class="res-grid"></div>
      
      <div class="title" style="margin:20px 0 12px">üìÜ Planning hebdomadaire</div>
      <div id="calendar" class="calendar"></div>
      <div class="foot">‚è∞ Cr√©neaux: 09h30‚Äì12h30 (matin), 13h30‚Äì17h30 (apr√®s-midi)</div>
    </section>

    <section class="panel" style="padding:20px">
      <div class="title" style="margin-bottom:16px">‚ú® Nouvelle r√©servation</div>
      <form id="frmRequest" class="grid" style="gap:12px">
        <div class="row">
          <input name="first_name" placeholder="Pr√©nom" required />
          <input name="last_name" placeholder="Nom" required />
        </div>
        <input name="service" placeholder="Service / Direction" required />
        <input type="hidden" name="resource_id" />
        <div class="row">
          <input type="date" name="date" required />
          <select name="window" required>
            <option value="AM">üåÖ Matin (09h30‚Äì12h30)</option>
            <option value="PM">‚òÄÔ∏è Apr√®s-midi (13h30‚Äì17h30)</option>
          </select>
        </div>
        <button class="btn-primary" type="submit">üöÄ R√©server ce cr√©neau</button>
      </form>
      <div class="foot">‚ÑπÔ∏è R√®gle: premier arriv√©, premier servi</div>
      
      <hr style="border:1px solid var(--line);margin:20px 0"/>
      
      <div class="title">üë• Occupations actuelles</div>
      <table class="table" id="tblNow"></table>
    </section>

    <section class="panel" style="grid-column:1/-1;padding:20px">
      <div class="sp" style="margin-bottom:16px">
        <div class="title">üí¨ Feedbacks r√©cents</div>
        <div class="row">
          <button class="btn" id="btnExport">üì• Exporter CSV</button>
          <button class="btn" id="btnAdmin">‚öôÔ∏è Admin</button>
        </div>
      </div>
      <table class="table" id="tblFb"></table>
    </section>

    <section class="panel hidden" id="adminPanel" style="grid-column:1/-1;padding:20px">
      <div class="sp" style="margin-bottom:16px">
        <div class="title">‚öôÔ∏è Administration</div>
        <div class="row wrap">
          <button class="btn" id="btnSync">üîÑ Sync avec Google Sheets</button>
          <button class="btn" onclick="window.open('https://docs.google.com/spreadsheets/d/'+CONFIG.sheetId+'/edit','_blank')">üìä Ouvrir la Sheet</button>
        </div>
      </div>
      <div class="grid" style="gap:12px;margin-top:16px">
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">Cl√© Admin (maurepas2025)</label>
          <input id="adminKey" placeholder="Cl√© admin" class="mono" value="" />
        </div>
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">URL du Script Apps Script</label>
          <input id="endpointInput" placeholder="https://script.google.com/macros/s/.../exec" class="mono" style="width:100%" />
        </div>
        <button class="btn-primary" id="btnSaveAdmin">üíæ Enregistrer la configuration</button>
      </div>
      <div class="foot" style="margin-top:16px">
        <div class="mono">Endpoint actuel: <span id="endpointView">non configur√©</span></div>
        <div style="margin-top:8px">
          <strong>üìù Instructions de configuration:</strong>
          <ol style="margin:8px 0;padding-left:20px;font-size:13px">
            <li>Dans Google Sheets, va dans Extensions ‚Üí Apps Script</li>
            <li>Colle le code du script fourni</li>
            <li>D√©ploie ‚Üí Nouveau d√©ploiement ‚Üí Type: Application Web</li>
            <li>Ex√©cuter en tant que: Moi / Acc√®s: Tout le monde</li>
            <li>Copie l'URL de d√©ploiement et colle-la ci-dessus</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <dialog id="dlgFb">
    <div class="sp" style="padding:16px 20px;border-bottom:1px solid var(--line)">
      <div class="title">üí¨ Laisser un commentaire</div>
      <button class="btn" id="fbClose">‚úñ Fermer</button>
    </div>
    <form id="frmFb" style="padding:16px 20px" class="grid">
      <div class="muted" id="fbContext"></div>
      <label>Note (1-5)
        <select name="rating" required>
          <option value="">Choisir</option>
          <option>‚≠ê 1</option>
          <option>‚≠ê‚≠ê 2</option>
          <option>‚≠ê‚≠ê‚≠ê 3</option>
          <option>‚≠ê‚≠ê‚≠ê‚≠ê 4</option>
          <option>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
        </select>
      </label>
      <textarea name="comment" rows="4" placeholder="Votre retour d'exp√©rience..." required></textarea>
      <input type="hidden" name="reservation_id" />
      <button class="btn-primary" type="submit">üì§ Envoyer</button>
    </form>
  </dialog>

  <script>
  // Config - √Ä CONFIGURER
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxit2Zhusl46Kr2hifBefNXo9Y2xgvBktG8qbiP6YMF6b8CuviybmdoMjWGej4ho3mK/exec'; // Remplace par l'URL de d√©ploiement de ton Apps Script
  const SHEET_ID = 'AKfycbxit2Zhusl46Kr2hifBefNXo9Y2xgvBktG8qbiP6YMF6b8CuviybmdoMjWGej4ho3mK'; // Remplace par l'ID de ta Google Sheet
  const ADMIN_KEY_DEFAULT = 'maurepas2025'; // Cl√© admin par d√©faut
  
  const CONFIG = { 
    endpoint: localStorage.getItem('endpoint') || APPS_SCRIPT_URL, 
    adminKey: localStorage.getItem('adminKey') || ADMIN_KEY_DEFAULT,
    sheetId: SHEET_ID
  };
  
  const TZ = 'Europe/Paris';

  // Catalogue des ressources avec emojis
  const DEFAULT_ITEMS = [
    {id:'PLAUD-1', name:'Plaud Note Pro #1', type:'Mat√©riel', site:'Secr√©tariat g√©n√©ral', notes:'Micro-cravate intelligent', icon:'üéôÔ∏è'},
    {id:'PLAUD-2', name:'Plaud Note Pro #2', type:'Mat√©riel', site:'Secr√©tariat g√©n√©ral', notes:'USB-C, transcription IA', icon:'üéôÔ∏è'},
    {id:'CHATGPT', name:'ChatGPT Pro', type:'Abonnement', site:'Licence', notes:'GPT-4 illimit√©', icon:'üí¨'},
    {id:'MISTRAL-1', name:'Mistral Pro #1', type:'Abonnement', site:'Licence', notes:'IA fran√ßaise', icon:'üá´üá∑'},
    {id:'MISTRAL-2', name:'Mistral Pro #2', type:'Abonnement', site:'Licence', notes:'IA fran√ßaise', icon:'üá´üá∑'},
    {id:'GEMINI', name:'Google Gemini + NotebookLM', type:'Abonnement', site:'Licence', notes:'Suite Google IA', icon:'‚ú®'},
    {id:'CLAUDE', name:'Claude Pro', type:'Abonnement', site:'Licence', notes:'Anthropic Claude 3', icon:'ü§ñ'},
    {id:'GAMMA', name:'Gamma Presentations', type:'Abonnement', site:'Licence', notes:'Pr√©sentations IA', icon:'üìä'}
  ];

  // Local storage
  const store = {
    getItems(){return JSON.parse(localStorage.getItem('items')||'null')||[]},
    setItems(v){localStorage.setItem('items',JSON.stringify(v))},
    getRes(){return JSON.parse(localStorage.getItem('reservations')||'[]')},
    setRes(v){localStorage.setItem('reservations',JSON.stringify(v))},
    getFb(){return JSON.parse(localStorage.getItem('feedback')||'[]')},
    setFb(v){localStorage.setItem('feedback',JSON.stringify(v))}
  };

  let ITEMS = (()=>{
    const v=store.getItems(); 
    if(Array.isArray(v)&&v.length) return v; 
    store.setItems(DEFAULT_ITEMS); 
    return DEFAULT_ITEMS;
  })();
  
  let RES = store.getRes();
  let FB  = store.getFb();
  let SELECTED_RESOURCE_ID = (ITEMS[0] && ITEMS[0].id) || null;

  // Helpers
  const el = s=>document.querySelector(s);
  const fmt = {
    ymd(d){const x=new Date(d); return x.toISOString().slice(0,10)},
    today(){return fmt.ymd(new Date())},
    weekStart(d){
      const x=new Date(d); 
      const day=(x.getDay()+6)%7; 
      x.setDate(x.getDate()-day); 
      x.setHours(0,0,0,0); 
      return x
    },
    addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x},
    who(r){return `${r.first_name} ${r.last_name} (${r.service})`}
  };

  // Grille ressources avec design am√©lior√©
  function renderResourceGrid(){
    const g = el('#resourceGrid'); 
    if(!g) return; 
    g.innerHTML='';
    
    const q = el('#q').value.toLowerCase(); 
    const type = el('#typeFilter').value;
    
    ITEMS
      .filter(x=>(!type||x.type===type)&&(!q||JSON.stringify(x).toLowerCase().includes(q)))
      .forEach(x=>{ 
        const d=document.createElement('div'); 
        d.className='card-res'+(SELECTED_RESOURCE_ID===x.id?' active':''); 
        d.dataset.id=x.id;
        d.innerHTML=`
          <div class="icon">${x.icon||'üì¶'}</div>
          <div class="name">${x.name}</div>
          <div class="meta">${x.type} ‚Ä¢ ${x.site}</div>
          ${x.notes?`<div class="chip">${x.notes}</div>`:''}
        `;
        d.onclick=()=>{ 
          SELECTED_RESOURCE_ID=x.id; 
          document.querySelectorAll('.card-res').forEach(n=>n.classList.remove('active')); 
          d.classList.add('active'); 
          const f=el('#frmRequest'); 
          if(f && f.resource_id) f.resource_id.value=x.id; 
          renderCalendar(); 
          renderNow(); 
        };
        g.appendChild(d);
      });
      
    if(!SELECTED_RESOURCE_ID && ITEMS.length){ 
      SELECTED_RESOURCE_ID=ITEMS[0].id; 
      renderResourceGrid(); 
    }
  }

  // R√©servations
  function findReservation(resource_id,date,win){ 
    return RES.find(r=>r.resource_id===resource_id && r.date===date && r.window===win && r.status==='ACTIVE'); 
  }

  // Calendrier am√©lior√©
  let weekOffset=0;
  function renderCalendar(){
    const resource_id = SELECTED_RESOURCE_ID || (ITEMS[0]&&ITEMS[0].id); 
    const wrap = el('#calendar'); 
    wrap.innerHTML=''; 
    if(!resource_id) return;
    
    const start = fmt.weekStart(new Date(Date.now()+weekOffset*7*24*3600*1000));
    
    // Header vide
    const header=document.createElement('div'); 
    header.className='h'; 
    header.textContent=''; 
    wrap.appendChild(header);
    
    // Headers jours
    for(let i=0;i<5;i++){ 
      const d=fmt.addDays(start,i); 
      const h=document.createElement('div'); 
      h.className='h'; 
      h.textContent=d.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'2-digit'}); 
      wrap.appendChild(h);
    }
    
    // Slots matin/apr√®s-midi
    ['AM','PM'].forEach(win=>{ 
      const label=document.createElement('div'); 
      label.className='slot'; 
      label.innerHTML= win==='AM' ? 
        'üåÖ <b>Matin</b><br><span class="mono muted">09h30‚Äì12h30</span>' : 
        '‚òÄÔ∏è <b>Apr√®s‚Äëmidi</b><br><span class="mono muted">13h30‚Äì17h30</span>'; 
      wrap.appendChild(label);
      
      for(let i=0;i<5;i++){ 
        const d=fmt.ymd(fmt.addDays(start,i)); 
        const r=findReservation(resource_id,d,win); 
        const cell=document.createElement('div'); 
        cell.className='slot '+(r?'busy':'free'); 
        cell.dataset.date=d; 
        cell.dataset.window=win; 
        cell.dataset.resource=resource_id; 
        cell.innerHTML=r?
          `<div class=who>üîí ${fmt.who(r)}</div>`:
          '<span class="libre-badge">‚úì Libre</span>'; 
        cell.onclick=onSlotClick; 
        wrap.appendChild(cell);
      } 
    });
  }

  function onSlotClick(e){ 
    const c=e.currentTarget; 
    const resource_id=c.dataset.resource; 
    const date=c.dataset.date; 
    const win=c.dataset.window; 
    const r=findReservation(resource_id,date,win); 
    const form=el('#frmRequest'); 
    form.resource_id.value=resource_id; 
    form.date.value=date; 
    form.window.value=win; 
    if(r){ 
      alert('‚ö†Ô∏è Cr√©neau d√©j√† r√©serv√© par '+fmt.who(r)); 
    } else { 
      window.scrollTo({top:0,behavior:'smooth'}); 
      form.date.style.borderColor = 'var(--accent)';
      form.window.style.borderColor = 'var(--accent)';
      setTimeout(()=>{
        form.date.style.borderColor = '';
        form.window.style.borderColor = '';
      },2000);
    } 
  }

  // Soumission r√©servation
  function submitRequest(e){ 
    e.preventDefault(); 
    const f=Object.fromEntries(new FormData(e.target)); 
    if(!f.resource_id){
      alert('‚ö†Ô∏è Veuillez s√©lectionner une ressource.');
      return;
    } 
    const exists=findReservation(f.resource_id,f.date,f.window); 
    if(exists){
      alert('‚ö†Ô∏è Ce cr√©neau est d√©j√† r√©serv√©.');
      return;
    } 
    const id='RES-'+Math.random().toString(36).slice(2,10).toUpperCase(); 
    const rec={id,status:'ACTIVE',created_ts:new Date().toISOString(),...f}; 
    RES.push(rec); 
    store.setRes(RES); 
    renderCalendar(); 
    renderNow(); 
    
    // Envoi au script Apps Script
    if(CONFIG.endpoint && CONFIG.endpoint !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'){ 
      fetch(CONFIG.endpoint,{
        method:'POST',
        mode:'no-cors', // Important pour Apps Script
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          type:'reservation.create',
          payload:rec,
          adminKey:CONFIG.adminKey
        })
      }).then(()=>{
        showSyncStatus('‚úì Sauvegard√© dans Google Sheets');
      }).catch((err)=>{
        console.log('Erreur sync:', err);
      }); 
    } 
    e.target.reset(); 
    alert('‚úÖ R√©servation confirm√©e !');
  }

  // Fonction pour afficher le statut de sync
  function showSyncStatus(msg){
    const status = el('#syncStatus');
    if(status){
      status.textContent = msg;
      status.style.display = 'inline';
      setTimeout(()=>{ status.style.display = 'none'; }, 3000);
    }
  }

  // Occupants actuels
  function renderNow(){ 
    const tbl=el('#tblNow'); 
    tbl.innerHTML='<tr><th>Ressource</th><th>Cr√©neau</th><th>Occupant</th><th>Action</th></tr>'; 
    const today=fmt.today(); 
    const win=(new Date().getHours()<13?'AM':'PM'); 
    
    ITEMS.forEach(it=>{ 
      const r=findReservation(it.id,today,win); 
      const tr=document.createElement('tr'); 
      tr.innerHTML=`
        <td class=title>${it.icon||'üì¶'} ${it.name}</td>
        <td class=muted>${win==='AM'?'üåÖ Matin':'‚òÄÔ∏è Apr√®s‚Äëmidi'}</td>
        <td>${r?'üë§ '+fmt.who(r):'<span class=muted>‚úì Libre</span>'}</td>
        <td>${r?`<button class="btn" data-fb='${r.id}'>üí¨ Commenter</button>`:''}</td>
      `; 
      tbl.appendChild(tr); 
    }); 
  }

  // Feedback
  function openFb(resId){ 
    const r=RES.find(x=>x.id===resId); 
    if(!r) return; 
    const it=ITEMS.find(x=>x.id===r.resource_id); 
    el('#fbContext').textContent=`${it.name} ‚Äì ${r.date} ${r.window==='AM'?'Matin':'Apr√®s‚Äëmidi'} (par ${fmt.who(r)})`; 
    el('#frmFb input[name="reservation_id"]').value=r.id; 
    dlgFb.showModal(); 
  }
  
  function submitFb(e){ 
    e.preventDefault(); 
    const f=Object.fromEntries(new FormData(e.target)); 
    const id='FB-'+Math.random().toString(36).slice(2,10).toUpperCase(); 
    const it=RES.find(r=>r.id===f.reservation_id); 
    const rating = f.rating.replace(/[^0-9]/g,'');
    const rec={
      id,
      created_ts:new Date().toISOString(),
      resource_id:it.resource_id,
      reservation_id:f.reservation_id,
      rating:+rating,
      comment:f.comment
    }; 
    FB.unshift(rec); 
    store.setFb(FB); 
    renderFb(); 
    dlgFb.close(); 
    
    // Envoi au script Apps Script
    if(CONFIG.endpoint && CONFIG.endpoint !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'){ 
      fetch(CONFIG.endpoint,{
        method:'POST',
        mode:'no-cors', // Important pour Apps Script
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          type:'feedback.create',
          payload:rec,
          adminKey:CONFIG.adminKey
        })
      }).then(()=>{
        showSyncStatus('‚úì Feedback envoy√©');
      }).catch((err)=>{
        console.log('Erreur sync feedback:', err);
      }); 
    } 
    e.target.reset(); 
    alert('‚úÖ Merci pour votre feedback !');
  }
  
  function renderFb(){ 
    const tbl=el('#tblFb'); 
    tbl.innerHTML='<tr><th>Ressource</th><th>Note</th><th>Commentaire</th><th>Date</th></tr>'; 
    FB.slice(0,20).forEach(f=>{ 
      const it=ITEMS.find(x=>x.id===f.resource_id)||{name:'(supprim√©)'}; 
      const tr=document.createElement('tr'); 
      const stars = '‚≠ê'.repeat(f.rating);
      tr.innerHTML=`
        <td class=title>${it.icon||'üì¶'} ${it.name}</td>
        <td>${stars}</td>
        <td>${f.comment}</td>
        <td class=muted>${new Date(f.created_ts).toLocaleString('fr-FR')}</td>
      `; 
      tbl.appendChild(tr); 
    }); 
  }

  // Export CSV
  function exportCSV(){ 
    const rows=[
      ["id","resource_id","date","window","first_name","last_name","service","status","created_ts"]
    ].concat(RES.map(r=>[
      r.id,r.resource_id,r.date,r.window,r.first_name,r.last_name,r.service,r.status,r.created_ts
    ])); 
    const csv=rows.map(r=>r.map(x=>`"${(x||'').toString().replaceAll('"','""')}"`).join(',')).join('\n'); 
    const blob=new Blob([csv],{type:'text/csv'}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download='reservations_'+new Date().toISOString().slice(0,10)+'.csv'; 
    a.click(); 
    URL.revokeObjectURL(url); 
  }

  // Admin + Sync
  function saveAdmin(){ 
    CONFIG.adminKey=el('#adminKey').value.trim(); 
    localStorage.setItem('adminKey',CONFIG.adminKey); 
    CONFIG.endpoint = el('#endpointInput').value.trim() || APPS_SCRIPT_URL;
    localStorage.setItem('endpoint', CONFIG.endpoint);
    alert('‚úÖ Configuration mise √† jour'); 
  }
  
  function syncServer(){ 
    if(!CONFIG.endpoint || CONFIG.endpoint === 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'){
      alert('‚ö†Ô∏è Veuillez configurer l\'URL du script Apps Script dans Admin.');
      return;
    } 
    const payload={
      type:'sync',
      payload:{
        items:ITEMS,
        reservations:RES,
        feedback:FB
      },
      adminKey:CONFIG.adminKey
    }; 
    fetch(CONFIG.endpoint,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    })
    .then(()=>{
      showSyncStatus('‚úÖ Synchronisation compl√®te');
      alert('‚úÖ Donn√©es synchronis√©es avec Google Sheets');
    })
    .catch((err)=>{
      console.log('Erreur:', err);
      alert('‚ùå Erreur de synchronisation');
    }); 
  }

  // Listeners
  document.addEventListener('click',e=>{ 
    const b=e.target.closest('button'); 
    if(!b) return; 
    if(b.id==='prevWeek'){weekOffset--; renderCalendar();} 
    if(b.id==='nextWeek'){weekOffset++; renderCalendar();} 
    if(b.id==='btnExport') exportCSV(); 
    if(b.id==='btnAdmin') el('#adminPanel').classList.toggle('hidden'); 
    if(b.dataset.fb) openFb(b.dataset.fb); 
  });
  
  el('#frmRequest').addEventListener('submit',submitRequest);
  el('#q').addEventListener('input',()=>{renderResourceGrid();});
  el('#typeFilter').addEventListener('change',()=>{renderResourceGrid();});
  el('#btnSaveAdmin').addEventListener('click',saveAdmin);
  el('#btnSync').addEventListener('click',syncServer);
  el('#fbClose').addEventListener('click',()=>dlgFb.close());
  el('#frmFb').addEventListener('submit',submitFb);

  // Boot
  (function init(){
    renderResourceGrid(); 
    renderCalendar(); 
    renderNow(); 
    renderFb();
    
    // Configuration initiale
    const endpoint = CONFIG.endpoint;
    const endpointView = el('#endpointView');
    const endpointInput = el('#endpointInput');
    const adminKeyInput = el('#adminKey');
    const sheetsLink = el('#sheetsLink');
    
    if(endpoint && endpoint !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'){
      endpointView.textContent = 'Configur√© ‚úì';
      endpointView.style.color = 'var(--ok)';
    } else {
      endpointView.textContent = 'Non configur√© - Voir instructions ci-dessous';
      endpointView.style.color = 'var(--warn)';
    }
    
    if(endpointInput) endpointInput.value = CONFIG.endpoint || '';
    if(adminKeyInput) adminKeyInput.value = CONFIG.adminKey || '';
    
    // Mise √† jour du lien Google Sheets
    if(sheetsLink && CONFIG.sheetId && CONFIG.sheetId !== 'YOUR_SHEET_ID'){
      sheetsLink.href = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit`;
    } else if(sheetsLink) {
      sheetsLink.onclick = (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Veuillez configurer l\'ID de la Google Sheet dans le code');
      };
    }
  })();
  </script>
</body>
</html>

