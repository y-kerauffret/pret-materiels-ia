<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√™t de mat√©riels IA ‚Äì R√©servations ‚Ä¢ v2</title>
  <style>
    :root{
      --bg:#0f1419;
      --bg-gradient:#0a0e13;
      --panel:#1a1f2e;
      --panel-hover:#232938;
      --muted:#8b92a9;
      --text:#e8eaed;
      --accent:#4f9cf9;
      --accent-hover:#6ba7ff;
      --ok:#4ade80;
      --warn:#fbbf24;
      --err:#f87171;
      --line:#2a3142;
      --chip:#162033;
      --chip-border:#2d4a7c;
      --input-bg:#0d1117;
      --day-free:#162033;
      --day-free-hover:#1e2d47;
      --day-busy:#4a2626;
      --day-selected:#1e3a5f;
      --day-partial:#3d3020;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0;
      background:linear-gradient(135deg,var(--bg),var(--bg-gradient));
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
    }
    
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(26,31,46,0.85);
      backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:20px;
    }
    
    h1{
      font-size:26px;
      margin:4px 0;
      font-weight:700;
      background:linear-gradient(135deg,#fff,#8b92a9);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    
    .sub{
      color:var(--muted);
      font-size:14px;
      margin-top:4px;
    }
    
    .grid{
      display:grid;
      gap:20px;
    }
    
    .cols-2{
      grid-template-columns:2fr 1fr;
    }
    
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      transition:transform 0.2s,box-shadow 0.2s;
      padding:20px;
    }
    
    .panel:hover{
      box-shadow:0 12px 48px rgba(0,0,0,0.5);
    }
    
    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .row.wrap{
      flex-wrap:wrap;
    }
    
    .sp{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    input,select,button,textarea{
      background:var(--input-bg);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:12px 16px;
      font:inherit;
      transition:all 0.2s;
    }
    
    input:focus,select:focus,textarea:focus{
      outline:2px solid var(--accent);
      border-color:transparent;
      background:rgba(79,156,249,0.05);
    }
    
    button{
      cursor:pointer;
      font-weight:500;
    }
    
    .btn{
      background:var(--panel);
      border:1px solid var(--line);
      color:var(--text);
      transition:all 0.2s;
    }
    
    .btn:hover{
      background:var(--panel-hover);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-hover));
      border:0;
      color:#fff;
      font-weight:600;
      box-shadow:0 4px 16px rgba(79,156,249,0.3);
    }
    
    .btn-primary:hover{
      box-shadow:0 6px 20px rgba(79,156,249,0.4);
      transform:translateY(-2px);
    }
    
    .muted{color:var(--muted)}
    .title{font-weight:700;font-size:18px;margin-bottom:12px;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    .hidden{display:none}
    
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    
    .table th,.table td{
      padding:12px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    
    .table th{
      color:var(--accent);
      font-weight:600;
      background:rgba(79,156,249,0.1);
    }
    
    .foot{
      color:var(--muted);
      font-size:13px;
      margin-top:12px;
    }
    
    @media (max-width:980px){
      .cols-2{grid-template-columns:1fr}
    }

    /* Grille ressources am√©lior√©e */
    .res-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:14px;
      margin-bottom:20px;
    }
    
    .card-res{
      border:2px solid var(--line);
      border-radius:14px;
      padding:16px;
      background:linear-gradient(135deg,var(--input-bg),var(--panel));
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    
    .card-res::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:2px;
      background:linear-gradient(90deg,transparent,var(--accent),transparent);
      transform:translateX(-100%);
      transition:transform 0.5s;
    }
    
    .card-res:hover::before{
      transform:translateX(100%);
    }
    
    .card-res:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(79,156,249,0.2);
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(79,156,249,0.1),var(--panel));
    }
    
    .card-res.active{
      border-color:var(--accent);
      background:linear-gradient(135deg,rgba(79,156,249,0.2),var(--panel));
      box-shadow:0 0 0 4px rgba(79,156,249,0.2),0 10px 30px rgba(79,156,249,0.3);
    }
    
    .card-res .icon{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-hover));
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
      font-size:20px;
    }
    
    .card-res .name{
      font-weight:700;
      font-size:16px;
      margin-bottom:4px;
    }
    
    .card-res .meta{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    
    .chip{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chip-border);
      color:var(--accent);
      font-size:12px;
      margin-top:8px;
      font-weight:500;
    }

    /* Calendrier mensuel */
    .calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    
    .calendar-month{
      font-size:20px;
      font-weight:700;
      color:var(--text);
    }
    
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      background:var(--input-bg);
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
    }
    
    .calendar-weekday{
      text-align:center;
      font-weight:600;
      color:var(--muted);
      padding:8px 4px;
      font-size:12px;
    }
    
    .calendar-day{
      aspect-ratio:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
      position:relative;
      border:1px solid transparent;
    }
    
    .calendar-day.free{
      background:var(--day-free);
    }
    
    .calendar-day.free:hover{
      background:var(--day-free-hover);
      border-color:var(--accent);
    }
    
    .calendar-day.busy{
      background:var(--day-busy);
      cursor:not-allowed;
      opacity:0.7;
    }
    
    .calendar-day.partial{
      background:var(--day-partial);
    }
    
    .calendar-day.selected{
      background:var(--day-selected);
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(79,156,249,0.3);
    }
    
    .calendar-day.start-date{
      border-radius:8px 0 0 8px;
      background:linear-gradient(90deg,var(--day-selected),var(--day-selected));
    }
    
    .calendar-day.end-date{
      border-radius:0 8px 8px 0;
    }
    
    .calendar-day.in-range{
      border-radius:0;
      background:var(--day-selected);
      opacity:0.8;
    }
    
    .calendar-day.other-month{
      opacity:0.3;
    }
    
    .calendar-day-number{
      font-size:14px;
      font-weight:500;
    }
    
    .calendar-day-info{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }
    
    /* L√©gende */
    .legend{
      display:flex;
      gap:16px;
      margin-top:12px;
      font-size:12px;
    }
    
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .legend-color{
      width:16px;
      height:16px;
      border-radius:4px;
    }

    /* Dialog am√©lior√© */
    dialog{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:16px;
      padding:0;
      width:min(560px,96vw);
      color:var(--text);
      box-shadow:0 20px 60px rgba(0,0,0,0.8);
    }
    
    dialog::backdrop{
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(4px);
    }

    /* Google Sheets Link */
    .sheets-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      background:linear-gradient(135deg,#34a853,#0f9d58);
      color:white;
      border-radius:8px;
      text-decoration:none;
      font-weight:500;
      transition:all 0.2s;
      font-size:14px;
    }
    
    .sheets-link:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(52,168,83,0.4);
    }
    
    /* Badge de r√©servation */
    .res-badge{
      display:inline-block;
      padding:4px 8px;
      background:rgba(79,156,249,0.2);
      color:var(--accent);
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      margin-top:4px;
    }
    
    /* Animations */
    @keyframes slideIn{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .panel{
      animation:slideIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap sp">
      <div>
        <h1>ü§ñ Pr√™t de mat√©riels IA</h1>
        <div class="sub">R√©servation de ressources IA ‚Ä¢ P√©riodes flexibles</div>
      </div>
      <div class="row">
        <select id="typeFilter">
          <option value="">Tous les types</option>
          <option value="Mat√©riel">Mat√©riel</option>
          <option value="Abonnement">Abonnement</option>
        </select>
        <input id="q" placeholder="üîç Rechercher..." />
        <a href="#" id="sheetsLink" target="_blank" class="sheets-link">
          üìä Google Sheets
        </a>
        <span id="syncStatus" style="color:var(--ok);font-size:12px;margin-left:8px;display:none">‚úì Synchronis√©</span>
      </div>
    </div>
  </header>

  <main class="wrap grid cols-2" style="margin-top:24px">
    <section class="panel">
      <div class="sp" style="margin-bottom:16px">
        <div>
          <div class="title">üìÖ Ressources disponibles</div>
          <div class="muted" style="font-size:13px">S√©lectionnez une ressource pour voir son planning</div>
        </div>
      </div>
      
      <div id="resourceGrid" class="res-grid"></div>
      
      <div class="title" style="margin:20px 0 12px">üìÜ Calendrier des disponibilit√©s</div>
      <div class="calendar-header">
        <button class="btn" id="prevMonth">‚óÄ Mois pr√©c√©dent</button>
        <div class="calendar-month" id="currentMonth">Novembre 2025</div>
        <button class="btn" id="nextMonth">Mois suivant ‚ñ∂</button>
      </div>
      
      <div class="calendar-grid" id="calendar"></div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background:var(--day-free)"></div>
          <span>Disponible</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--day-selected)"></div>
          <span>Votre s√©lection</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--day-busy)"></div>
          <span>R√©serv√©</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--day-partial)"></div>
          <span>Partiellement disponible</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="title" style="margin-bottom:16px">‚ú® Nouvelle r√©servation</div>
      <form id="frmRequest" class="grid" style="gap:12px">
        <div class="row">
          <input name="first_name" placeholder="Pr√©nom" required />
          <input name="last_name" placeholder="Nom" required />
        </div>
        <input name="service" placeholder="Service / Direction" required />
        <input type="hidden" name="resource_id" />
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">üìÖ Date de d√©but</label>
          <input type="date" name="date_start" id="date_start" required />
        </div>
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">üìÖ Date de fin</label>
          <input type="date" name="date_end" id="date_end" required />
        </div>
        <div id="reservationSummary" class="hidden" style="padding:12px;background:var(--chip);border-radius:8px;border:1px solid var(--chip-border)">
          <div style="font-weight:600;margin-bottom:4px">üìå R√©capitulatif</div>
          <div id="summaryText" style="font-size:13px;color:var(--muted)"></div>
        </div>
        <button class="btn-primary" type="submit">üöÄ R√©server cette p√©riode</button>
      </form>
      <div class="foot">‚ÑπÔ∏è Vous pouvez r√©server plusieurs jours cons√©cutifs</div>
      
      <hr style="border:1px solid var(--line);margin:20px 0"/>
      
      <div class="title">üìã Mes r√©servations actives</div>
      <div id="myReservations"></div>
    </section>

    <section class="panel" style="grid-column:1/-1">
      <div class="sp" style="margin-bottom:16px">
        <div class="title">üí¨ Feedbacks r√©cents</div>
        <div class="row">
          <button class="btn" id="btnExport">üì• Exporter CSV</button>
          <button class="btn" id="btnAdmin">‚öôÔ∏è Admin</button>
        </div>
      </div>
      <table class="table" id="tblFb"></table>
    </section>

    <section class="panel hidden" id="adminPanel" style="grid-column:1/-1">
      <div class="sp" style="margin-bottom:16px">
        <div class="title">‚öôÔ∏è Administration</div>
        <div class="row wrap">
          <button class="btn" id="btnSync">üîÑ Sync avec Google Sheets</button>
          <button class="btn" onclick="window.open('https://docs.google.com/spreadsheets/d/'+CONFIG.sheetId+'/edit','_blank')">üìä Ouvrir la Sheet</button>
        </div>
      </div>
      <div class="grid" style="gap:12px;margin-top:16px">
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">Cl√© Admin (maurepas2025)</label>
          <input id="adminKey" placeholder="Cl√© admin" class="mono" value="" />
        </div>
        <div>
          <label style="display:block;margin-bottom:8px;color:var(--muted)">URL du Script Apps Script</label>
          <input id="endpointInput" placeholder="https://script.google.com/macros/s/.../exec" class="mono" style="width:100%" />
        </div>
        <button class="btn-primary" id="btnSaveAdmin">üíæ Enregistrer la configuration</button>
      </div>
      <div class="foot" style="margin-top:16px">
        <div class="mono">Endpoint actuel: <span id="endpointView">non configur√©</span></div>
      </div>
    </section>
  </main>

  <dialog id="dlgFb">
    <div class="sp" style="padding:16px 20px;border-bottom:1px solid var(--line)">
      <div class="title">üí¨ Laisser un commentaire</div>
      <button class="btn" id="fbClose">‚úñ Fermer</button>
    </div>
    <form id="frmFb" style="padding:16px 20px" class="grid" style="gap:12px">
      <div class="muted" id="fbContext"></div>
      <label style="display:block;margin-bottom:8px">Note (1-5)
        <select name="rating" required style="width:100%;margin-top:8px">
          <option value="">Choisir une note</option>
          <option value="1">‚≠ê 1 - Insuffisant</option>
          <option value="2">‚≠ê‚≠ê 2 - Moyen</option>
          <option value="3">‚≠ê‚≠ê‚≠ê 3 - Bien</option>
          <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 - Tr√®s bien</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 - Excellent</option>
        </select>
      </label>
      <label style="display:block">Commentaire
        <textarea name="comment" rows="4" placeholder="Votre retour d'exp√©rience..." required style="width:100%;margin-top:8px"></textarea>
      </label>
      <input type="hidden" name="reservation_id" />
      <button class="btn-primary" type="submit">üì§ Envoyer le feedback</button>
    </form>
  </dialog>

  <script>
  // Config - √Ä CONFIGURER
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/1XfUrDtnmKDYhneWvshhatZO7g8FD4u18ZQzKMkRTzJBMeVCwanbU3TGy/exec'; // Remplace par l'URL de d√©ploiement
  const SHEET_ID = '1_2T_YnYApMlsVNpApM0BdfdoHkH_Z1eHs6-AW3m_sxQ/edit?gid=0#gid=0'; // Remplace par l'ID de ta Google Sheet
  const ADMIN_KEY_DEFAULT = 'maurepas2025';
  
  const CONFIG = { 
    endpoint: localStorage.getItem('endpoint') || APPS_SCRIPT_URL, 
    adminKey: localStorage.getItem('adminKey') || ADMIN_KEY_DEFAULT,
    sheetId: SHEET_ID
  };

  // Catalogue des ressources
  const DEFAULT_ITEMS = [
    {id:'PLAUD-1', name:'Plaud Note Pro #1', type:'Mat√©riel', site:'Secr√©tariat g√©n√©ral', notes:'Micro-cravate intelligent', icon:'üéôÔ∏è'},
    {id:'PLAUD-2', name:'Plaud Note Pro #2', type:'Mat√©riel', site:'Secr√©tariat g√©n√©ral', notes:'USB-C, transcription IA', icon:'üéôÔ∏è'},
    {id:'CHATGPT', name:'ChatGPT Pro', type:'Abonnement', site:'Licence', notes:'GPT-4 illimit√©', icon:'üí¨'},
    {id:'MISTRAL-1', name:'Mistral Pro #1', type:'Abonnement', site:'Licence', notes:'IA fran√ßaise', icon:'üá´üá∑'},
    {id:'MISTRAL-2', name:'Mistral Pro #2', type:'Abonnement', site:'Licence', notes:'IA fran√ßaise', icon:'üá´üá∑'},
    {id:'GEMINI', name:'Google Gemini + NotebookLM', type:'Abonnement', site:'Licence', notes:'Suite Google IA', icon:'‚ú®'},
    {id:'CLAUDE', name:'Claude Pro', type:'Abonnement', site:'Licence', notes:'Anthropic Claude 3', icon:'ü§ñ'},
    {id:'GAMMA', name:'Gamma Presentations', type:'Abonnement', site:'Licence', notes:'Pr√©sentations IA', icon:'üìä'}
  ];

  // Local storage
  const store = {
    getItems(){return JSON.parse(localStorage.getItem('items')||'null')||[]},
    setItems(v){localStorage.setItem('items',JSON.stringify(v))},
    getRes(){return JSON.parse(localStorage.getItem('reservations')||'[]')},
    setRes(v){localStorage.setItem('reservations',JSON.stringify(v))},
    getFb(){return JSON.parse(localStorage.getItem('feedback')||'[]')},
    setFb(v){localStorage.setItem('feedback',JSON.stringify(v))}
  };

  let ITEMS = (()=>{
    const v=store.getItems(); 
    if(Array.isArray(v)&&v.length) return v; 
    store.setItems(DEFAULT_ITEMS); 
    return DEFAULT_ITEMS;
  })();
  
  let RES = store.getRes();
  let FB  = store.getFb();
  let SELECTED_RESOURCE_ID = (ITEMS[0] && ITEMS[0].id) || null;
  let SELECTED_START_DATE = null;
  let SELECTED_END_DATE = null;
  let CURRENT_MONTH = new Date();

  // Helpers
  const el = s=>document.querySelector(s);
  const fmt = {
    ymd(d){const x=new Date(d); return x.toISOString().slice(0,10)},
    formatDate(d){
      const x=new Date(d);
      return x.toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
    },
    getDaysInMonth(year, month){
      return new Date(year, month + 1, 0).getDate();
    },
    getFirstDayOfMonth(year, month){
      return new Date(year, month, 1).getDay();
    },
    daysBetween(d1, d2){
      const ms = Math.abs(new Date(d2) - new Date(d1));
      return Math.floor(ms / (1000 * 60 * 60 * 24)) + 1;
    }
  };

  // Grille ressources
  function renderResourceGrid(){
    const g = el('#resourceGrid'); 
    if(!g) return; 
    g.innerHTML='';
    
    const q = el('#q').value.toLowerCase(); 
    const type = el('#typeFilter').value;
    
    ITEMS
      .filter(x=>(!type||x.type===type)&&(!q||JSON.stringify(x).toLowerCase().includes(q)))
      .forEach(x=>{ 
        const d=document.createElement('div'); 
        d.className='card-res'+(SELECTED_RESOURCE_ID===x.id?' active':''); 
        d.dataset.id=x.id;
        
        // Compter les r√©servations actives
        const activeRes = RES.filter(r=>r.resource_id===x.id && r.status==='ACTIVE').length;
        
        d.innerHTML=`
          <div class="icon">${x.icon||'üì¶'}</div>
          <div class="name">${x.name}</div>
          <div class="meta">${x.type} ‚Ä¢ ${x.site}</div>
          ${x.notes?`<div class="chip">${x.notes}</div>`:''}
          ${activeRes > 0 ? `<div class="res-badge">${activeRes} r√©servation(s)</div>` : ''}
        `;
        d.onclick=()=>{ 
          SELECTED_RESOURCE_ID=x.id; 
          document.querySelectorAll('.card-res').forEach(n=>n.classList.remove('active')); 
          d.classList.add('active'); 
          const f=el('#frmRequest'); 
          if(f && f.resource_id) f.resource_id.value=x.id; 
          renderCalendar();
          renderMyReservations();
        };
        g.appendChild(d);
      });
      
    if(!SELECTED_RESOURCE_ID && ITEMS.length){ 
      SELECTED_RESOURCE_ID=ITEMS[0].id; 
      renderResourceGrid(); 
    }
  }

  // V√©rifier si une date est dans une p√©riode de r√©servation
  function isDateBusy(resource_id, date){
    const dateStr = fmt.ymd(date);
    return RES.some(r => {
      if(r.resource_id !== resource_id || r.status !== 'ACTIVE') return false;
      const start = new Date(r.date_start || r.date);
      const end = new Date(r.date_end || r.date);
      const checkDate = new Date(dateStr);
      return checkDate >= start && checkDate <= end;
    });
  }

  // Calendrier mensuel
  function renderCalendar(){
    const wrap = el('#calendar');
    if(!wrap) return;
    wrap.innerHTML = '';
    
    const year = CURRENT_MONTH.getFullYear();
    const month = CURRENT_MONTH.getMonth();
    const daysInMonth = fmt.getDaysInMonth(year, month);
    const firstDay = fmt.getFirstDayOfMonth(year, month);
    
    // Afficher le nom du mois
    el('#currentMonth').textContent = CURRENT_MONTH.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
    
    // Jours de la semaine
    const weekdays = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
    weekdays.forEach(day => {
      const d = document.createElement('div');
      d.className = 'calendar-weekday';
      d.textContent = day;
      wrap.appendChild(d);
    });
    
    // Cases vides avant le premier jour
    const startOffset = firstDay === 0 ? 6 : firstDay - 1;
    for(let i = 0; i < startOffset; i++){
      const empty = document.createElement('div');
      empty.className = 'calendar-day other-month';
      wrap.appendChild(empty);
    }
    
    // Jours du mois
    for(let day = 1; day <= daysInMonth; day++){
      const date = new Date(year, month, day);
      const dateStr = fmt.ymd(date);
      const isWeekend = date.getDay() === 0 || date.getDay() === 6;
      const isBusy = isDateBusy(SELECTED_RESOURCE_ID, date);
      
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      dayEl.dataset.date = dateStr;
      
      // D√©terminer la classe
      if(isBusy){
        dayEl.classList.add('busy');
      } else {
        dayEl.classList.add('free');
      }
      
      // V√©rifier si c'est dans la s√©lection
      if(SELECTED_START_DATE && SELECTED_END_DATE){
        const d = new Date(dateStr);
        const start = new Date(SELECTED_START_DATE);
        const end = new Date(SELECTED_END_DATE);
        if(d >= start && d <= end){
          dayEl.classList.add('selected');
          if(dateStr === SELECTED_START_DATE) dayEl.classList.add('start-date');
          if(dateStr === SELECTED_END_DATE) dayEl.classList.add('end-date');
          if(dateStr !== SELECTED_START_DATE && dateStr !== SELECTED_END_DATE) dayEl.classList.add('in-range');
        }
      }
      
      dayEl.innerHTML = `
        <div class="calendar-day-number">${day}</div>
        ${isWeekend ? '<div class="calendar-day-info">WE</div>' : ''}
        ${isBusy ? '<div class="calendar-day-info">R√©serv√©</div>' : ''}
      `;
      
      if(!isBusy){
        dayEl.onclick = () => selectDate(dateStr);
      }
      
      wrap.appendChild(dayEl);
    }
  }

  // S√©lection de date
  function selectDate(date){
    if(!SELECTED_START_DATE || (SELECTED_START_DATE && SELECTED_END_DATE)){
      // Premi√®re s√©lection ou reset
      SELECTED_START_DATE = date;
      SELECTED_END_DATE = null;
      const startInput = el('#date_start');
      const endInput = el('#date_end');
      if(startInput) startInput.value = date;
      if(endInput) endInput.value = '';
      el('#reservationSummary').classList.add('hidden');
    } else {
      // Deuxi√®me s√©lection
      const d1 = new Date(SELECTED_START_DATE);
      const d2 = new Date(date);
      if(d2 >= d1){
        SELECTED_END_DATE = date;
        const endInput = el('#date_end');
        if(endInput) endInput.value = date;
        
        // V√©rifier qu'aucun jour entre les deux n'est occup√©
        let hasConflict = false;
        let currentDate = new Date(SELECTED_START_DATE);
        const endDate = new Date(SELECTED_END_DATE);
        while(currentDate <= endDate){
          if(isDateBusy(SELECTED_RESOURCE_ID, currentDate)){
            hasConflict = true;
            break;
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        if(hasConflict){
          alert('‚ö†Ô∏è Certains jours dans cette p√©riode sont d√©j√† r√©serv√©s');
          SELECTED_START_DATE = null;
          SELECTED_END_DATE = null;
          const startInput = el('#date_start');
          const endInput = el('#date_end');
          if(startInput) startInput.value = '';
          if(endInput) endInput.value = '';
        } else {
          updateReservationSummary();
        }
      } else {
        // Si date ant√©rieure, on inverse
        SELECTED_END_DATE = SELECTED_START_DATE;
        SELECTED_START_DATE = date;
        const startInput = el('#date_start');
        const endInput = el('#date_end');
        if(startInput) startInput.value = date;
        if(endInput) endInput.value = SELECTED_END_DATE;
        updateReservationSummary();
      }
    }
    renderCalendar();
  }

  // Mise √† jour du r√©sum√©
  function updateReservationSummary(){
    if(SELECTED_START_DATE && SELECTED_END_DATE){
      const days = fmt.daysBetween(SELECTED_START_DATE, SELECTED_END_DATE);
      const resource = ITEMS.find(x=>x.id===SELECTED_RESOURCE_ID);
      el('#summaryText').innerHTML = `
        <div>üì¶ <strong>${resource ? resource.name : 'Ressource'}</strong></div>
        <div>üìÖ Du ${fmt.formatDate(SELECTED_START_DATE)} au ${fmt.formatDate(SELECTED_END_DATE)}</div>
        <div>‚è±Ô∏è Dur√©e: ${days} jour(s)</div>
      `;
      el('#reservationSummary').classList.remove('hidden');
    } else {
      el('#reservationSummary').classList.add('hidden');
    }
  }

  // Soumission r√©servation
  function submitRequest(e){ 
    e.preventDefault(); 
    const formData = new FormData(e.target);
    const f = Object.fromEntries(formData); 
    
    // Debug pour voir les donn√©es
    console.log('Donn√©es du formulaire:', f);
    
    if(!f.resource_id){
      alert('‚ö†Ô∏è Veuillez s√©lectionner une ressource.');
      return;
    }
    
    if(!f.date_start || !f.date_end){
      alert('‚ö†Ô∏è Veuillez s√©lectionner une p√©riode compl√®te.');
      return;
    }
    
    // V√©rifier les conflits
    let currentDate = new Date(f.date_start);
    const endDate = new Date(f.date_end);
    while(currentDate <= endDate){
      if(isDateBusy(f.resource_id, currentDate)){
        alert('‚ö†Ô∏è Certains jours sont d√©j√† r√©serv√©s dans cette p√©riode.');
        return;
      }
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    const id='RES-'+Math.random().toString(36).slice(2,10).toUpperCase(); 
    const rec={
      id: id,
      status: 'ACTIVE',
      created_ts: new Date().toISOString(),
      resource_id: f.resource_id,
      date_start: f.date_start,  // S'assurer que ces champs existent
      date_end: f.date_end,      // S'assurer que ces champs existent
      first_name: f.first_name,
      last_name: f.last_name,
      service: f.service
    }; 
    
    console.log('Donn√©es √† envoyer:', rec);
    
    RES.push(rec); 
    store.setRes(RES); 
    
    // Envoi au script Apps Script
    if(CONFIG.endpoint && CONFIG.endpoint !== 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'){ 
      fetch(CONFIG.endpoint,{
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          type:'reservation.create',
          payload:rec,
          adminKey:CONFIG.adminKey
        })
      }).then(()=>{
        showSyncStatus('‚úì Sauvegard√© dans Google Sheets');
      }).catch((err)=>{
        console.log('Erreur sync:', err);
      }); 
    }
    
    // Reset
    SELECTED_START_DATE = null;
    SELECTED_END_DATE = null;
    e.target.reset(); 
    el('#reservationSummary').classList.add('hidden');
    renderCalendar(); 
    renderMyReservations();
    renderResourceGrid();
    
    alert('‚úÖ R√©servation confirm√©e !');
  }

  // Afficher mes r√©servations
  function renderMyReservations(){
    const container = el('#myReservations');
    if(!container) return;
    
    const myRes = RES.filter(r => r.resource_id === SELECTED_RESOURCE_ID && r.status === 'ACTIVE')
                     .sort((a,b) => new Date(b.date_start || b.date) - new Date(a.date_start || a.date))
                     .slice(0, 5);
    
    if(myRes.length === 0){
      container.innerHTML = '<div class="muted">Aucune r√©servation active</div>';
      return;
    }
    
    container.innerHTML = '';
    
    myRes.forEach(r => {
      const resource = ITEMS.find(x => x.id === r.resource_id);
      const days = r.date_end && r.date_start ? fmt.daysBetween(r.date_start, r.date_end) : 1;
      const div = document.createElement('div');
      div.style.cssText = 'padding:12px;background:var(--chip);border-radius:8px;margin-bottom:8px';
      
      div.innerHTML = `
        <div style="font-weight:600">${resource ? resource.name : r.resource_id}</div>
        <div style="font-size:13px;color:var(--muted);margin-top:4px">
          üë§ ${r.first_name} ${r.last_name} (${r.service})<br>
          üìÖ ${fmt.formatDate(r.date_start || r.date)} ${r.date_end ? '‚Üí ' + fmt.formatDate(r.date_end) : ''}<br>
          ‚è±Ô∏è ${days} jour(s)
        </div>
      `;
      
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.style.marginTop = '8px';
      btn.textContent = 'üí¨ Commenter';
      btn.onclick = () => openFeedback(r.id);
      
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // Feedback
  function openFeedback(resId){
    console.log('Opening feedback for:', resId); 
    const r=RES.find(x=>x.id===resId); 
    if(!r) return; 
    const it=ITEMS.find(x=>x.id===r.resource_id);
    const days = r.date_end ? fmt.daysBetween(r.date_start, r.date_end) : 1;
    el('#fbContext').innerHTML = `
      <strong>${it ? it.name : 'Ressource'}</strong><br>
      R√©servation du ${fmt.formatDate(r.date_start || r.date)} 
      ${r.date_end ? 'au ' + fmt.formatDate(r.date_end) : ''} 
      (${days} jour(s))<br>
      Par ${r.first_name} ${r.last_name} (${r.service})
    `; 
    el('#frmFb input[name="reservation_id"]').value=r.id;
    const dialog = el('#dlgFb');
    if(dialog) dialog.showModal(); 
  }
  
  window.openFeedback = openFeedback; // Rendre la fonction globale
  
  function submitFb(e){ 
    e.preventDefault(); 
    const f=Object.fromEntries(new FormData(e.target)); 
    const id='FB-'+Math.random().toString(36).slice(2,10).toUpperCase(); 
    const it=RES.find(r=>r.id===f.reservation_id);
    
    const rec={
      id,
      created_ts:new Date().toISOString(),
      resource_id:it.resource_id,
      reservation_id:f.reservation_id,
      rating:+f.rating,
      comment:f.comment
    }; 
    
    FB.unshift(rec); 
    store.setFb(FB); 
    renderFb();
    
    const dialog = el('#dlgFb');
    if(dialog) dialog.close(); 
    
    // Envoi au script Apps Script
    if(CONFIG.endpoint && CONFIG.endpoint !== "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"){ 
      fetch(CONFIG.endpoint,{
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          type:'feedback.create',
          payload:rec,
          adminKey:CONFIG.adminKey
        })
      }).then(()=>{
        showSyncStatus('‚úì Feedback envoy√©');
      }).catch((err)=>{
        console.log('Erreur sync feedback:', err);
      }); 
    } 
    
    e.target.reset(); 
    alert('‚úÖ Merci pour votre feedback !');
  }
  
  function renderFb(){ 
    const tbl=el('#tblFb'); 
    tbl.innerHTML='<tr><th>Ressource</th><th>Note</th><th>Commentaire</th><th>Date</th></tr>'; 
    FB.slice(0,10).forEach(f=>{ 
      const it=ITEMS.find(x=>x.id===f.resource_id)||{name:'(supprim√©)',icon:'üì¶'}; 
      const tr=document.createElement('tr'); 
      const stars = '‚≠ê'.repeat(f.rating);
      tr.innerHTML=`
        <td>${it.icon||'üì¶'} ${it.name}</td>
        <td>${stars}</td>
        <td>${f.comment}</td>
        <td class=muted>${new Date(f.created_ts).toLocaleString('fr-FR')}</td>
      `; 
      tbl.appendChild(tr); 
    }); 
  }

  // Export CSV
  function exportCSV(){ 
    const rows=[
      ["id","resource_id","date_start","date_end","first_name","last_name","service","status","created_ts"]
    ].concat(RES.map(r=>[
      r.id,r.resource_id,r.date_start||r.date,r.date_end||r.date,r.first_name,r.last_name,r.service,r.status,r.created_ts
    ])); 
    const csv=rows.map(r=>r.map(x=>`"${(x||'').toString().replaceAll('"','""')}"`).join(',')).join('\n'); 
    const blob=new Blob([csv],{type:'text/csv'}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); 
    a.href=url; 
    a.download='reservations_'+new Date().toISOString().slice(0,10)+'.csv'; 
    a.click(); 
    URL.revokeObjectURL(url); 
  }

  // Admin + Sync
  function saveAdmin(){ 
    CONFIG.adminKey=el('#adminKey').value.trim(); 
    localStorage.setItem('adminKey',CONFIG.adminKey); 
    CONFIG.endpoint = el('#endpointInput').value.trim() || APPS_SCRIPT_URL;
    localStorage.setItem('endpoint', CONFIG.endpoint);
    alert('‚úÖ Configuration mise √† jour'); 
  }
  
  function syncServer(){ 
    if(!CONFIG.endpoint || CONFIG.endpoint === APPS_SCRIPT_URL){
      alert('‚ö†Ô∏è Veuillez configurer l\'URL du script Apps Script dans Admin.');
      return;
    } 
    const payload={
      type:'sync',
      payload:{
        items:ITEMS,
        reservations:RES,
        feedback:FB
      },
      adminKey:CONFIG.adminKey
    }; 
    fetch(CONFIG.endpoint,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    })
    .then(()=>{
      showSyncStatus('‚úÖ Synchronisation compl√®te');
      alert('‚úÖ Donn√©es synchronis√©es avec Google Sheets');
    })
    .catch((err)=>{
      console.log('Erreur:', err);
      alert('‚ùå Erreur de synchronisation');
    }); 
  }

  function showSyncStatus(msg){
    const status = el('#syncStatus');
    if(status){
      status.textContent = msg;
      status.style.display = 'inline';
      setTimeout(()=>{ status.style.display = 'none'; }, 3000);
    }
  }

  // Listeners
  document.addEventListener('click',e=>{ 
    const b=e.target.closest('button'); 
    if(!b) return;
    
    if(b.id==='prevMonth'){
      CURRENT_MONTH.setMonth(CURRENT_MONTH.getMonth() - 1);
      renderCalendar();
    }
    if(b.id==='nextMonth'){
      CURRENT_MONTH.setMonth(CURRENT_MONTH.getMonth() + 1);
      renderCalendar();
    }
    if(b.id==='btnExport') exportCSV();
    if(b.id==='btnAdmin'){
      const panel = el('#adminPanel');
      if(panel) panel.classList.toggle('hidden');
    }
  });
  
  el('#frmRequest')?.addEventListener('submit',submitRequest);
  el('#q')?.addEventListener('input',()=>{renderResourceGrid();});
  el('#typeFilter')?.addEventListener('change',()=>{renderResourceGrid();});
  el('#btnSaveAdmin')?.addEventListener('click',saveAdmin);
  el('#btnSync')?.addEventListener('click',syncServer);
  el('#fbClose')?.addEventListener('click',()=>{
    const dialog = el('#dlgFb');
    if(dialog) dialog.close();
  });
  el('#frmFb')?.addEventListener('submit',submitFb);
  
  // Sync dates manuelles avec calendrier
  const startInput = el('#date_start');
  const endInput = el('#date_end');
  
  if(startInput){
    startInput.addEventListener('change',(e)=>{
      SELECTED_START_DATE = e.target.value;
      renderCalendar();
      updateReservationSummary();
    });
  }
  
  if(endInput){
    endInput.addEventListener('change',(e)=>{
      SELECTED_END_DATE = e.target.value;
      renderCalendar();
      updateReservationSummary();
    });
  }

  // Boot
  (function init(){
    renderResourceGrid(); 
    renderCalendar();
    renderMyReservations();
    renderFb();
    
    // Configuration initiale
    const endpoint = CONFIG.endpoint;
    const endpointView = el('#endpointView');
    const endpointInput = el('#endpointInput');
    const adminKeyInput = el('#adminKey');
    const sheetsLink = el('#sheetsLink');
    
    if(endpoint && endpoint !== APPS_SCRIPT_URL){
      endpointView.textContent = 'Configur√© ‚úì';
      endpointView.style.color = 'var(--ok)';
    } else {
      endpointView.textContent = 'Non configur√© - Configurer ci-dessus';
      endpointView.style.color = 'var(--warn)';
    }
    
    if(endpointInput) endpointInput.value = CONFIG.endpoint || '';
    if(adminKeyInput) adminKeyInput.value = CONFIG.adminKey || '';
    
    // Mise √† jour du lien Google Sheets
    if(sheetsLink && CONFIG.sheetId && CONFIG.sheetId !== 'YOUR_SHEET_ID'){
      sheetsLink.href = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit`;
    } else if(sheetsLink) {
      sheetsLink.onclick = (e) => {
        e.preventDefault();
        alert('‚ö†Ô∏è Veuillez configurer l\'ID de la Google Sheet dans le code');
      };
    }
  })();
  </script>
</body>
</html>
